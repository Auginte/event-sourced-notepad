<html>
<head>
    <title>Auginte: {{project}}</title>
</head>
<body>
    <h1>{{project}}: {{uuid}}</h1>
    <h2>Add element</h2>
    <form id="addElementForm">
        Name: <input id="elementName">
        <button type="submit" id="addElement">Create project</button>
    </form>

    <div id="data">Loading greatness...</div>

    <script type="text/javascript">
        function addElement() {
            var elementNameInput = document.getElementById("elementName");
            var name = elementNameInput.value;

            var healhChecked = {
                event: "HealthChecked",
            };
            var elementAdded = {
                event: "ElementAdded",
                type: "Text",
                data: name,
            };

            var http = new XMLHttpRequest();
            var url = "/project/{{project}}";
            var params = JSON.stringify(healhChecked) + "\n" + JSON.stringify(elementAdded) + "\n";
            http.open("POST", url, true);
            http.setRequestHeader("Content-type", "application/json");

            http.onreadystatechange = function() {
                console.log("http.readyState", http.readyState);
                console.log("http.status", http.status);
                console.log("http.responseText", http.responseText);
            };
            http.send(params);

            elementNameInput.value = "";
            elementNameInput.focus();
            return false;
        };

        document.getElementById("addElementForm").onsubmit = function(event) {
            event.preventDefault();
            return addElement();
        };

        document.getElementById("addElement").onclick = addElement;
    </script>

    <script type="text/javascript">
        var source = new EventSource('/stream');
        var dataElement = document.getElementById("data")

        function appendData(data) {
            var div = document.createElement("div");
            div.innerHTML = data
            dataElement.appendChild(div)
        }

        source.addEventListener('message', function(e) {
          appendData(e.data);
          var parsed = JSON.parse(e.data);
          console.log(parsed, e);
        }, false);

        source.addEventListener('open', function(e) {
          console.log("OPEN", e)
        }, false);

        source.addEventListener('error', function(e) {
          if (e.readyState == EventSource.CLOSED) {
            console.log("CLOSED", e)
          } else {
            console.log("ERROR", e)
          }
        }, false);
    </script>
</body>
</html>